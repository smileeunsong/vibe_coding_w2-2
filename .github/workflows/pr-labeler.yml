name: PR ë¼ë²¨ ìë™ ë“±ë¡

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  label-pr:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ìë™ ë¼ë²¨ë§
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const branchName = context.payload.pull_request.head.ref;
            const prTitle = context.payload.pull_request.title;
            const baseBranch = context.payload.pull_request.base.ref;

            let labels = [];

            // ë¸Œëœì¹˜ëª… ê¸°ë°˜ ë¼ë²¨ë§
            if (branchName.startsWith('feature/')) {
              labels.push('type/feature');
            } else if (branchName.startsWith('bugfix/')) {
              labels.push('type/bugfix');
            } else if (branchName.startsWith('hotfix/')) {
              labels.push('type/hotfix', 'priority/high');
            } else if (branchName.startsWith('refactor/')) {
              labels.push('type/refactor');
            } else {
              labels.push('type/other');
            }

            // PR ì œëª© ê¸°ë°˜ ë¼ë²¨ë§
            const titleLower = prTitle.toLowerCase();
            if (titleLower.includes('wip') || titleLower.includes('work in progress')) {
              labels.push('status/wip');
            }
            if (titleLower.includes('breaking')) {
              labels.push('breaking-change');
            }
            if (titleLower.includes('test')) {
              labels.push('type/test');
            }
            if (titleLower.includes('doc')) {
              labels.push('type/documentation');
            }

            // íƒ€ê²Ÿ ë¸Œëœì¹˜ ê¸°ë°˜ ë¼ë²¨ë§
            if (baseBranch === 'main') {
              labels.push('target/main');
            } else if (baseBranch === 'develop') {
              labels.push('target/develop');
            }

            // ë³€ê²½ëœ íŒŒì¼ ê¸°ë°˜ ë¼ë²¨ë§
            try {
              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              const fileNames = files.map(file => file.filename);
              
              // íŒŒì¼ ê²½ë¡œ ê¸°ë°˜ ë¼ë²¨ë§
              const hasBackendChanges = fileNames.some(name => name.startsWith('backend/'));
              const hasFrontendChanges = fileNames.some(name => name.startsWith('frontend/'));
              const hasTestChanges = fileNames.some(name => name.includes('test'));
              const hasDocChanges = fileNames.some(name => name.endsWith('.md') || name.includes('doc'));
              const hasConfigChanges = fileNames.some(name => 
                name.includes('requirements.txt') || 
                name.includes('config') || 
                name.includes('.yml') || 
                name.includes('.yaml')
              );
              
              if (hasBackendChanges) labels.push('area/backend');
              if (hasFrontendChanges) labels.push('area/frontend');
              if (hasTestChanges) labels.push('area/test');
              if (hasDocChanges) labels.push('area/documentation');
              if (hasConfigChanges) labels.push('area/config');
              
              // ë³€ê²½ í¬ê¸° ê¸°ë°˜ ë¼ë²¨ë§
              const totalChanges = files.reduce((sum, file) => sum + file.changes, 0);
              if (totalChanges < 10) {
                labels.push('size/xs');
              } else if (totalChanges < 50) {
                labels.push('size/small');
              } else if (totalChanges < 200) {
                labels.push('size/medium');
              } else if (totalChanges < 500) {
                labels.push('size/large');
              } else {
                labels.push('size/xl');
              }
              
            } catch (error) {
              console.error('íŒŒì¼ ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
            }

            // ì¤‘ë³µ ì œê±°
            labels = [...new Set(labels)];

            // ë¼ë²¨ ì ìš©
            if (labels.length > 0) {
              try {
                await github.rest.issues.setLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: labels
                });
                
                console.log(`ì ìš©ëœ ë¼ë²¨: ${labels.join(', ')}`);
                
                // ë¼ë²¨ë§ ê²°ê³¼ ëŒ“ê¸€
                const comment = `
                ## ğŸ·ï¸ ìë™ ë¼ë²¨ë§ ì™„ë£Œ
                
                ë‹¤ìŒ ë¼ë²¨ì´ ìë™ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤:
                ${labels.map(label => `- \`${label}\``).join('\n')}
                
                *ë¼ë²¨ì€ ë¸Œëœì¹˜ëª…, PR ì œëª©, ë³€ê²½ëœ íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.*
                `;
                
                await github.rest.issues.createComment({
                  issue_number: prNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
                
              } catch (error) {
                console.error('ë¼ë²¨ ì ìš© ì¤‘ ì˜¤ë¥˜:', error);
              }
            }
