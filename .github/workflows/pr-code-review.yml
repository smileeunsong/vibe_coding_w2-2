name: PR ì½”ë“œ ë¦¬ë·° ìžë™ ë“±ë¡

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-code-review:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy bandit safety

      - name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
        id: code-quality
        run: |
          echo "# ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼" > review_comments.md
          echo "" >> review_comments.md

          # Flake8 ê²€ì‚¬ (ì½”ë”© ìŠ¤íƒ€ì¼)
          echo "## ðŸ“‹ ì½”ë”© ìŠ¤íƒ€ì¼ ê²€ì‚¬ (flake8)" >> review_comments.md
          if flake8 backend/ frontend/ --max-line-length=88 --extend-ignore=E203,W503 > flake8_output.txt 2>&1; then
            echo "âœ… ì½”ë”© ìŠ¤íƒ€ì¼ ê²€ì‚¬ í†µê³¼" >> review_comments.md
          else
            echo "âŒ ì½”ë”© ìŠ¤íƒ€ì¼ ì´ìŠˆ ë°œê²¬:" >> review_comments.md
            echo "\`\`\`" >> review_comments.md
            cat flake8_output.txt >> review_comments.md
            echo "\`\`\`" >> review_comments.md
          fi
          echo "" >> review_comments.md

          # Black í¬ë§·íŒ… ê²€ì‚¬
          echo "## ðŸŽ¨ ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ (black)" >> review_comments.md
          if black --check backend/ frontend/ > black_output.txt 2>&1; then
            echo "âœ… ì½”ë“œ í¬ë§·íŒ… ì¼ê´€ì„± í™•ì¸" >> review_comments.md
          else
            echo "âŒ í¬ë§·íŒ… ê°œì„  í•„ìš”:" >> review_comments.md
            echo "\`\`\`" >> review_comments.md
            cat black_output.txt >> review_comments.md
            echo "\`\`\`" >> review_comments.md
            echo "**ê¶Œìž¥ì‚¬í•­**: \`black backend/ frontend/\` ì‹¤í–‰í•˜ì—¬ ìžë™ í¬ë§·íŒ…" >> review_comments.md
          fi
          echo "" >> review_comments.md

          # Import ì •ë ¬ ê²€ì‚¬
          echo "## ðŸ“¦ Import ì •ë ¬ ê²€ì‚¬ (isort)" >> review_comments.md
          if isort --check-only backend/ frontend/ > isort_output.txt 2>&1; then
            echo "âœ… Import ì •ë ¬ í™•ì¸" >> review_comments.md
          else
            echo "âŒ Import ì •ë ¬ ê°œì„  í•„ìš”:" >> review_comments.md
            echo "**ê¶Œìž¥ì‚¬í•­**: \`isort backend/ frontend/\` ì‹¤í–‰í•˜ì—¬ ìžë™ ì •ë ¬" >> review_comments.md
          fi
          echo "" >> review_comments.md

          # ë³´ì•ˆ ê²€ì‚¬
          echo "## ðŸ”’ ë³´ì•ˆ ê²€ì‚¬ (bandit)" >> review_comments.md
          if bandit -r backend/ -f txt > bandit_output.txt 2>&1; then
            echo "âœ… ë³´ì•ˆ ì´ìŠˆ ì—†ìŒ" >> review_comments.md
          else
            echo "âš ï¸ ë³´ì•ˆ ê²€í†  í•„ìš”:" >> review_comments.md
            echo "\`\`\`" >> review_comments.md
            tail -20 bandit_output.txt >> review_comments.md
            echo "\`\`\`" >> review_comments.md
          fi

      - name: íŒŒì¼ ë³€ê²½ ë¶„ì„
        id: file-analysis
        run: |
          echo "" >> review_comments.md
          echo "## ðŸ“ íŒŒì¼ ë³€ê²½ ë¶„ì„" >> review_comments.md

          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
          git diff --name-only origin/${{ github.base_ref }}..HEAD > changed_files.txt

          if [ -s changed_files.txt ]; then
            echo "**ë³€ê²½ëœ íŒŒì¼ë“¤:**" >> review_comments.md
            while read file; do
              echo "- \`$file\`" >> review_comments.md
            done < changed_files.txt
            
            echo "" >> review_comments.md
            echo "**ë¦¬ë·° í¬ì¸íŠ¸:**" >> review_comments.md
            
            # íŒŒì¼ë³„ ë¦¬ë·° í¬ì¸íŠ¸
            while read file; do
              if [[ $file == *.py ]]; then
                echo "- \`$file\`: Python ì½”ë“œ - í•¨ìˆ˜/í´ëž˜ìŠ¤ ì„¤ê³„, ì˜ˆì™¸ ì²˜ë¦¬, í…ŒìŠ¤íŠ¸ ì½”ë“œ í™•ì¸" >> review_comments.md
              elif [[ $file == *requirements.txt ]]; then
                echo "- \`$file\`: ì˜ì¡´ì„± ë³€ê²½ - ë³´ì•ˆì„±, ë¼ì´ì„ ìŠ¤, ë²„ì „ í˜¸í™˜ì„± í™•ì¸" >> review_comments.md
              elif [[ $file == *.md ]]; then
                echo "- \`$file\`: ë¬¸ì„œ - ì •í™•ì„±, ì™„ì „ì„±, ê°€ë…ì„± í™•ì¸" >> review_comments.md
              elif [[ $file == *.yml ]] || [[ $file == *.yaml ]]; then
                echo "- \`$file\`: ì„¤ì • íŒŒì¼ - êµ¬ë¬¸, ë³´ì•ˆ, í™˜ê²½ë³„ ì„¤ì • í™•ì¸" >> review_comments.md
              fi
            done < changed_files.txt
          fi

      - name: ìžë™ ì½”ë“œ ë¦¬ë·° ëŒ“ê¸€ ë“±ë¡
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            try {
              const reviewComments = fs.readFileSync('review_comments.md', 'utf8');
              
              const comment = `
              ## ðŸ¤– ìžë™ ì½”ë“œ ë¦¬ë·°
              
              ${reviewComments}
              
              ---
              
              ### ðŸ’¡ ì¼ë°˜ì ì¸ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸
              
              **ê¸°ëŠ¥ì„±**
              - [ ] ìš”êµ¬ì‚¬í•­ì— ë§žê²Œ êµ¬í˜„ë˜ì—ˆëŠ”ê°€?
              - [ ] ì˜ˆì™¸ ìƒí™©ì´ ì ì ˆížˆ ì²˜ë¦¬ë˜ì—ˆëŠ”ê°€?
              - [ ] ì„±ëŠ¥ìƒ ë¬¸ì œëŠ” ì—†ëŠ”ê°€?
              
              **ì½”ë“œ í’ˆì§ˆ**
              - [ ] í•¨ìˆ˜/í´ëž˜ìŠ¤ê°€ ë‹¨ì¼ ì±…ìž„ì„ ê°–ëŠ”ê°€?
              - [ ] ë³€ìˆ˜ëª…ê³¼ í•¨ìˆ˜ëª…ì´ ëª…í™•í•œê°€?
              - [ ] ì£¼ì„ì´ í•„ìš”í•œ ë¶€ë¶„ì— ì ì ˆížˆ ìž‘ì„±ë˜ì—ˆëŠ”ê°€?
              
              **í…ŒìŠ¤íŠ¸**
              - [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ê°€ ìž‘ì„±ë˜ì—ˆëŠ”ê°€?
              - [ ] í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ê°€ ì¶©ë¶„í•œê°€?
              - [ ] ì—£ì§€ ì¼€ì´ìŠ¤ê°€ í…ŒìŠ¤íŠ¸ë˜ì—ˆëŠ”ê°€?
              
              **ë³´ì•ˆ**
              - [ ] ìž…ë ¥ê°’ ê²€ì¦ì´ ì ì ˆí•œê°€?
              - [ ] ë¯¼ê°í•œ ì •ë³´ê°€ ë…¸ì¶œë˜ì§€ ì•ŠëŠ”ê°€?
              - [ ] SQL ì¸ì ì…˜ ë“± ë³´ì•ˆ ì·¨ì•½ì ì´ ì—†ëŠ”ê°€?
              
              *ì´ ë¦¬ë·°ëŠ” ìžë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì¶”ê°€ì ì¸ ìˆ˜ë™ ë¦¬ë·°ë¥¼ ê¶Œìž¥í•©ë‹ˆë‹¤.* ðŸ”
              `;
              
              await github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
            } catch (error) {
              console.error('ë¦¬ë·° ëŒ“ê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜:', error);
            }
